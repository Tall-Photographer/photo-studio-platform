// packages/backend/prisma/schema.prisma
// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  SUPER_ADMIN
  STUDIO_ADMIN
  MANAGER
  PHOTOGRAPHER
  VIDEOGRAPHER
  ASSISTANT
  EDITOR
  CLIENT
}

enum BookingStatus {
  DRAFT
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum ProjectStatus {
  NOT_STARTED
  IN_PROGRESS
  IN_EDITING
  CLIENT_REVIEW
  DELIVERED
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentGateway {
  STRIPE
  PAYPAL
  SQUARE
  AUTHORIZE_NET
  BRAINTREE
  MANUAL
}

enum Currency {
  USD
  EUR
  GBP
  CAD
  AUD
  JPY
  CNY
  INR
  AED
  SAR
}

// Core Models
model Studio {
  id                    String                @id @default(cuid())
  name                  String
  slug                  String                @unique
  logo                  String?
  primaryColor          String                @default("#000000")
  secondaryColor        String                @default("#ffffff")
  fontFamily            String                @default("Inter")
  
  // Contact & Business Info
  email                 String                @unique
  phone                 String?
  website               String?
  address               String?
  city                  String?
  state                 String?
  country               String?
  postalCode            String?
  timezone              String                @default("UTC")
  businessHours         Json?
  
  // Financial Settings
  defaultCurrency       Currency              @default(USD)
  taxRate               Decimal               @default(0)
  taxId                 String?
  
  // Features & Limits
  maxUsers              Int                   @default(10)
  maxStorageGB          Int                   @default(100)
  features              Json                  @default("{}")
  
  // Subscription
  subscriptionId        String?
  subscriptionStatus    String                @default("trial")
  subscriptionEndDate   DateTime?
  
  // Metadata
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  deletedAt             DateTime?
  
  // Relations
  users                 User[]
  clients               Client[]
  bookings              Booking[]
  equipment             Equipment[]
  rooms                 Room[]
  projects              Project[]
  invoices              Invoice[]
  payments              Payment[]
  expenses              Expense[]
  emailTemplates        EmailTemplate[]
  emailCampaigns        EmailCampaign[]
  notifications         Notification[]
  files                 File[]
  auditLogs             AuditLog[]
  systemSettings        SystemSetting[]
  currencyRates         CurrencyExchangeRate[]
}

model User {
  id                    String                @id @default(cuid())
  studioId              String
  
  // Basic Info
  email                 String                @unique
  password              String
  firstName             String
  lastName              String
  role                  UserRole
  
  // Contact Info
  phone                 String?
  
  // Authentication
  emailVerified         Boolean               @default(false)
  emailVerificationToken String?
  passwordResetToken    String?
  passwordResetExpires  DateTime?
  
  // 2FA
  twoFactorEnabled      Boolean               @default(false)
  twoFactorSecret       String?
  
  // OAuth
  googleId              String?
  facebookId            String?
  appleId               String?
  
  // Activity
  lastLoginAt           DateTime?
  lastLoginIp           String?
  loginCount            Int                   @default(0)
  
  // Professional Info
  hourlyRate            Decimal?
  skills                String[]              @default([])
  specializations       String[]              @default([])
  
  // Metadata
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  deletedAt             DateTime?
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  sessions              UserSession[]
  bookingAssignments    BookingAssignment[]
  projectAssignments    ProjectAssignment[]
  equipmentCheckouts    EquipmentAssignment[]
  createdBookings       Booking[]             @relation("BookingCreatedBy")
  createdProjects       Project[]             @relation("ProjectCreatedBy")
  createdInvoices       Invoice[]             @relation("InvoiceCreatedBy")
  notifications         Notification[]
  auditLogs             AuditLog[]
  editorProjects        Project[]             @relation("ProjectEditor")
  expenses              Expense[]
  
  @@index([studioId, role])
  @@index([email])
}

model UserSession {
  id                    String                @id @default(cuid())
  userId                String
  token                 String                @unique
  refreshToken          String                @unique
  
  // Device & Location
  userAgent             String?
  ip                    String?
  deviceId              String?
  deviceType            String?
  
  // Expiry
  expiresAt             DateTime
  refreshExpiresAt      DateTime
  
  // Metadata
  createdAt             DateTime              @default(now())
  lastActivityAt        DateTime              @default(now())
  
  // Relations
  user                  User                  @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([token])
  @@index([refreshToken])
}

model Client {
  id                    String                @id @default(cuid())
  studioId              String
  
  // Contact Info
  firstName             String
  lastName              String
  email                 String
  phone                 String?
  company               String?
  
  // Address
  address               String?
  city                  String?
  state                 String?
  country               String?
  postalCode            String?
  
  // Preferences
  preferredContactMethod String               @default("email")
  notes                 String?
  tags                  String[]              @default([])
  
  // Business Info
  totalSpent            Decimal               @default(0)
  totalBookings         Int                   @default(0)
  averageRating         Decimal?
  loyaltyPoints         Int                   @default(0)
  
  // Marketing
  marketingConsent      Boolean               @default(false)
  emailOptIn            Boolean               @default(true)
  smsOptIn              Boolean               @default(false)
  
  // Metadata
  source                String?               // referral, website, social, etc.
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  deletedAt             DateTime?
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  bookings              Booking[]
  invoices              Invoice[]
  payments              Payment[]
  
  @@index([studioId])
  @@index([email])
}

model Booking {
  id                    String                @id @default(cuid())
  studioId              String
  clientId              String
  createdById           String
  
  // Booking Details
  bookingNumber         String                @unique
  title                 String
  description           String?
  status                BookingStatus         @default(PENDING)
  
  // Timing
  startDate             DateTime
  endDate               DateTime
  duration              Int                   // in minutes
  setupTime             Int                   @default(0) // in minutes
  breakdownTime         Int                   @default(0) // in minutes
  
  // Location
  location              String?
  address               String?
  
  // Pricing
  basePrice             Decimal
  currency              Currency              @default(USD)
  taxAmount             Decimal               @default(0)
  discountAmount        Decimal               @default(0)
  totalAmount           Decimal
  
  // Requirements
  equipmentNeeded       String[]              @default([])
  specialRequirements   String?
  shotListId            String?
  
  // Metadata
  notes                 String?
  internalNotes         String?
  tags                  String[]              @default([])
  isRecurring           Boolean               @default(false)
  recurringPattern      Json?
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  deletedAt             DateTime?
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  client                Client                @relation(fields: [clientId], references: [id])
  createdBy             User                  @relation("BookingCreatedBy", fields: [createdById], references: [id])
  assignments           BookingAssignment[]
  roomAssignments       RoomAssignment[]
  equipmentAssignments  EquipmentAssignment[]
  projects              Project[]
  invoices              Invoice[]
  payments              Payment[]
  
  @@index([studioId, status])
  @@index([clientId])
  @@index([startDate])
  @@index([bookingNumber])
}

model BookingAssignment {
  id                    String                @id @default(cuid())
  bookingId             String
  userId                String
  
  // Assignment Details
  role                  String                // photographer, assistant, etc.
  rate                  Decimal?
  currency              Currency              @default(USD)
  hours                 Decimal?
  
  // Status
  isConfirmed           Boolean               @default(false)
  confirmedAt           DateTime?
  
  // Metadata
  notes                 String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  project               Project               @relation(fields: [projectId], references: [id])
  user                  User                  @relation(fields: [userId], references: [id])
  
  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Invoice {
  id                    String                @id @default(cuid())
  studioId              String
  clientId              String
  bookingId             String?
  createdById           String
  
  // Invoice Details
  invoiceNumber         String                @unique
  title                 String?
  description           String?
  status                InvoiceStatus         @default(DRAFT)
  
  // Dates
  issueDate             DateTime              @default(now())
  dueDate               DateTime
  paidDate              DateTime?
  
  // Financial
  subtotal              Decimal
  taxAmount             Decimal               @default(0)
  discountAmount        Decimal               @default(0)
  totalAmount           Decimal
  paidAmount            Decimal               @default(0)
  balanceAmount         Decimal
  currency              Currency              @default(USD)
  
  // Payment Terms
  paymentTerms          String?               // "Net 30", "Due on Receipt", etc.
  
  // Metadata
  notes                 String?
  internalNotes         String?
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  deletedAt             DateTime?
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  client                Client                @relation(fields: [clientId], references: [id])
  booking               Booking?              @relation(fields: [bookingId], references: [id])
  createdBy             User                  @relation("InvoiceCreatedBy", fields: [createdById], references: [id])
  lineItems             InvoiceLineItem[]
  payments              Payment[]
  
  @@index([studioId, status])
  @@index([clientId])
  @@index([invoiceNumber])
}

model InvoiceLineItem {
  id                    String                @id @default(cuid())
  invoiceId             String
  
  // Line Item Details
  description           String
  quantity              Decimal
  unitPrice             Decimal
  totalPrice            Decimal
  
  // Metadata
  sortOrder             Int                   @default(0)
  
  // Relations
  invoice               Invoice               @relation(fields: [invoiceId], references: [id])
  
  @@index([invoiceId])
}

model Payment {
  id                    String                @id @default(cuid())
  studioId              String
  clientId              String
  invoiceId             String?
  bookingId             String?
  
  // Payment Details
  paymentNumber         String                @unique
  amount                Decimal
  currency              Currency              @default(USD)
  status                PaymentStatus         @default(PENDING)
  gateway               PaymentGateway        @default(MANUAL)
  
  // Gateway Details
  gatewayTransactionId  String?
  gatewayResponse       Json?
  
  // Payment Method
  paymentMethod         String?               // card, bank_transfer, cash, etc.
  
  // Dates
  paymentDate           DateTime              @default(now())
  processedAt           DateTime?
  
  // Metadata
  description           String?
  metadata              Json?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  client                Client                @relation(fields: [clientId], references: [id])
  invoice               Invoice?              @relation(fields: [invoiceId], references: [id])
  booking               Booking?              @relation(fields: [bookingId], references: [id])
  
  @@index([studioId, status])
  @@index([clientId])
  @@index([paymentNumber])
}

model Expense {
  id                    String                @id @default(cuid())
  studioId              String
  userId                String
  
  // Expense Details
  category              String
  description           String
  amount                Decimal
  currency              Currency              @default(USD)
  
  // Dates
  expenseDate           DateTime
  
  // Receipt
  receiptUrl            String?
  
  // Approval
  isApproved            Boolean               @default(false)
  approvedBy            String?
  approvedAt            DateTime?
  
  // Reimbursement
  isReimbursable        Boolean               @default(false)
  isReimbursed          Boolean               @default(false)
  reimbursedAt          DateTime?
  
  // Metadata
  vendor                String?
  projectReference      String?
  notes                 String?
  tags                  String[]              @default([])
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  user                  User                  @relation(fields: [userId], references: [id])
  
  @@index([studioId, category])
  @@index([userId])
}

model EmailTemplate {
  id                    String                @id @default(cuid())
  studioId              String
  
  // Template Info
  name                  String
  subject               String
  type                  String                // booking_confirmation, invoice, etc.
  
  // Content
  htmlContent           String
  textContent           String?
  
  // Template Variables
  variables             Json?                 // available variables for this template
  
  // Usage
  isActive              Boolean               @default(true)
  isSystem              Boolean               @default(false)
  
  // Metadata
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  
  @@index([studioId, type])
}

model EmailCampaign {
  id                    String                @id @default(cuid())
  studioId              String
  
  // Campaign Details
  name                  String
  subject               String
  status                String                @default("draft") // draft, scheduled, sending, sent, cancelled
  
  // Content
  htmlContent           String
  textContent           String?
  
  // Targeting
  targetAudience        Json?                 // filtering criteria
  
  // Scheduling
  scheduledAt           DateTime?
  sentAt                DateTime?
  
  // Statistics
  totalRecipients       Int                   @default(0)
  sentCount             Int                   @default(0)
  deliveredCount        Int                   @default(0)
  openedCount           Int                   @default(0)
  clickedCount          Int                   @default(0)
  bouncedCount          Int                   @default(0)
  unsubscribedCount     Int                   @default(0)
  
  // Metadata
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  recipients            CampaignRecipient[]
  
  @@index([studioId, status])
}

model CampaignRecipient {
  id                    String                @id @default(cuid())
  campaignId            String
  email                 String
  
  // Status
  status                String                @default("pending") // pending, sent, delivered, opened, clicked, bounced, unsubscribed
  
  // Tracking
  sentAt                DateTime?
  deliveredAt           DateTime?
  openedAt              DateTime?
  clickedAt             DateTime?
  bouncedAt             DateTime?
  unsubscribedAt        DateTime?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  campaign              EmailCampaign         @relation(fields: [campaignId], references: [id])
  
  @@index([campaignId])
  @@index([email])
}

model Notification {
  id                    String                @id @default(cuid())
  studioId              String
  userId                String
  
  // Notification Details
  type                  String                // booking_reminder, payment_received, etc.
  title                 String
  message               String
  
  // Status
  isRead                Boolean               @default(false)
  readAt                DateTime?
  
  // Actions
  actionUrl             String?
  actionText            String?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime              @default(now())
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  user                  User                  @relation(fields: [userId], references: [id])
  
  @@index([studioId, userId])
  @@index([isRead])
}

model File {
  id                    String                @id @default(cuid())
  studioId              String
  projectId             String?
  
  // File Details
  filename              String
  originalName          String
  mimeType              String
  size                  Int
  
  // Storage
  url                   String
  thumbnailUrl          String?
  
  // File Type
  type                  String                // image, video, document, etc.
  category              String?               // raw, edited, final, etc.
  
  // Metadata
  metadata              Json?
  tags                  String[]              @default([])
  
  // Access Control
  isPublic              Boolean               @default(false)
  
  // Processing Status
  isProcessed           Boolean               @default(false)
  processedAt           DateTime?
  
  // Client Access
  clientVisible         Boolean               @default(false)
  downloadCount         Int                   @default(0)
  
  // Metadata
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  deletedAt             DateTime?
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  project               Project?              @relation(fields: [projectId], references: [id])
  
  @@index([studioId, type])
  @@index([projectId])
}

model CurrencyExchangeRate {
  id                    String                @id @default(cuid())
  studioId              String
  
  // Currency Pair
  fromCurrency          Currency
  toCurrency            Currency
  
  // Rate
  rate                  Decimal
  validFrom             DateTime
  validTo               DateTime?
  
  // Source
  source                String                @default("manual") // manual, api, bank
  
  // Metadata
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  
  @@unique([studioId, fromCurrency, toCurrency, validFrom])
  @@index([studioId])
}

model SystemSetting {
  id                    String                @id @default(cuid())
  studioId              String
  
  // Setting
  key                   String
  value                 Json
  category              String
  
  // Metadata
  description           String?
  isPublic              Boolean               @default(false)
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  
  @@unique([studioId, key])
  @@index([studioId, category])
}

model AuditLog {
  id                    String                @id @default(cuid())
  studioId              String
  userId                String
  
  // Action Details
  action                String                // create, update, delete, login, etc.
  entity                String                // user, booking, invoice, etc.
  entityId              String?
  
  // Changes
  oldValues             Json?
  newValues             Json?
  
  // Request Info
  ipAddress             String?
  userAgent             String?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime              @default(now())
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  user                  User                  @relation(fields: [userId], references: [id])
  
  @@index([studioId, entity])
  @@index([userId])
  @@index([createdAt])
}datedAt
  
  // Relations
  booking               Booking               @relation(fields: [bookingId], references: [id])
  user                  User                  @relation(fields: [userId], references: [id])
  
  @@unique([bookingId, userId])
  @@index([bookingId])
  @@index([userId])
}

model Equipment {
  id                    String                @id @default(cuid())
  studioId              String
  
  // Equipment Details
  name                  String
  description           String?
  category              String
  brand                 String?
  model                 String?
  serialNumber          String?
  
  // Tracking
  qrCode                String?               @unique
  location              String?
  status                String                @default("available") // available, in_use, maintenance, retired
  
  // Financial
  purchasePrice         Decimal?
  currency              Currency              @default(USD)
  purchaseDate          DateTime?
  warrantyExpires       DateTime?
  
  // Maintenance
  lastMaintenanceDate   DateTime?
  nextMaintenanceDate   DateTime?
  maintenanceNotes      String?
  
  // Usage
  totalUsageHours       Int                   @default(0)
  
  // Metadata
  notes                 String?
  tags                  String[]              @default([])
  images                String[]              @default([])
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  deletedAt             DateTime?
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  assignments           EquipmentAssignment[]
  
  @@index([studioId, category])
  @@index([status])
  @@index([qrCode])
}

model EquipmentAssignment {
  id                    String                @id @default(cuid())
  equipmentId           String
  userId                String
  bookingId             String?
  
  // Assignment Details
  checkedOutAt          DateTime              @default(now())
  checkedInAt           DateTime?
  expectedReturnDate    DateTime?
  
  // Condition
  conditionOut          String?               // excellent, good, fair, poor
  conditionIn           String?
  notes                 String?
  
  // Metadata
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  equipment             Equipment             @relation(fields: [equipmentId], references: [id])
  user                  User                  @relation(fields: [userId], references: [id])
  booking               Booking?              @relation(fields: [bookingId], references: [id])
  
  @@index([equipmentId])
  @@index([userId])
  @@index([bookingId])
}

model Room {
  id                    String                @id @default(cuid())
  studioId              String
  
  // Room Details
  name                  String
  description           String?
  type                  String                // studio, office, storage, etc.
  
  // Specifications
  dimensions            String?               // "20x15x10 feet"
  capacity              Int?                  // max people
  features              String[]              @default([]) // lighting, backdrop, etc.
  
  // Pricing
  hourlyRate            Decimal?
  currency              Currency              @default(USD)
  
  // Availability
  isAvailable           Boolean               @default(true)
  
  // Metadata
  notes                 String?
  images                String[]              @default([])
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  deletedAt             DateTime?
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  assignments           RoomAssignment[]
  
  @@index([studioId])
}

model RoomAssignment {
  id                    String                @id @default(cuid())
  roomId                String
  bookingId             String
  
  // Assignment Details
  startTime             DateTime
  endTime               DateTime
  
  // Metadata
  notes                 String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  room                  Room                  @relation(fields: [roomId], references: [id])
  booking               Booking               @relation(fields: [bookingId], references: [id])
  
  @@index([roomId])
  @@index([bookingId])
}

model Project {
  id                    String                @id @default(cuid())
  studioId              String
  bookingId             String?
  createdById           String
  editorId              String?
  
  // Project Details
  projectNumber         String                @unique
  title                 String
  description           String?
  status                ProjectStatus         @default(NOT_STARTED)
  
  // Deliverables
  deliveryDate          DateTime?
  deliveryMethod        String?               // email, cloud, physical
  
  // File Management
  totalFiles            Int                   @default(0)
  processedFiles        Int                   @default(0)
  approvedFiles         Int                   @default(0)
  
  // Progress Tracking
  progressPercentage    Int                   @default(0)
  
  // Client Communication
  clientApprovalRequired Boolean              @default(false)
  clientApprovedAt      DateTime?
  clientFeedback        String?
  
  // Metadata
  notes                 String?
  internalNotes         String?
  tags                  String[]              @default([])
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  deletedAt             DateTime?
  
  // Relations
  studio                Studio                @relation(fields: [studioId], references: [id])
  booking               Booking?              @relation(fields: [bookingId], references: [id])
  createdBy             User                  @relation("ProjectCreatedBy", fields: [createdById], references: [id])
  editor                User?                 @relation("ProjectEditor", fields: [editorId], references: [id])
  assignments           ProjectAssignment[]
  files                 File[]
  
  @@index([studioId, status])
  @@index([bookingId])
  @@index([projectNumber])
}

model ProjectAssignment {
  id                    String                @id @default(cuid())
  projectId             String
  userId                String
  
  // Assignment Details
  role                  String                // editor, reviewer, etc.
  assignedAt            DateTime              @default(now())
  
  // Status
  isCompleted           Boolean               @default(false)
  completedAt           DateTime?
  
  // Metadata
  notes                 String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @up